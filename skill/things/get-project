#!/usr/bin/env bash

# Retrieves detailed information for a single Things3 Project by ID
# Usage: ./get-project <project_id>

# Check if project ID is provided
if [ -z "$1" ]; then
    echo "Error: Project ID is required" >&2
    echo "Usage: ./get-project <project_id>" >&2
    exit 1
fi

PROJECT_ID="$1"

osascript - "$PROJECT_ID" << 'EOF'
on replaceText(theText, findText, replaceWith)
    set oldDelims to AppleScript's text item delimiters
    set AppleScript's text item delimiters to findText
    set textItems to every text item of theText
    set AppleScript's text item delimiters to replaceWith
    set theText to textItems as string
    set AppleScript's text item delimiters to oldDelims
    return theText
end replaceText

on run argv
    set projectID to item 1 of argv as string
    
    tell application "Things3"
        -- Try to get the project by ID
        try
            set theProject to project id projectID
        on error
            error "Error: Project not found with ID: " & projectID
        end try
        
        -- Get basic fields
        set project_id to id of theProject
        set project_name to name of theProject
        set project_status to (status of theProject) as string
        
        -- Get area if exists
        set area_id_str to ""
        set area_name_str to ""
        try
            set projectArea to area of theProject
            if projectArea is not missing value then
                set area_id_str to id of projectArea
                set area_name_str to name of projectArea
            end if
        end try
        
        -- Get notes
        set project_notes to ""
        try
            set project_notes to notes of theProject as string
        end try
        
        -- Get tag names
        set tag_names_str to ""
        try
            set tag_list to tag names of theProject
            if (count of tag_list) > 0 then
                set oldDelims to AppleScript's text item delimiters
                set AppleScript's text item delimiters to "; "
                set tag_names_str to tag_list as string
                set AppleScript's text item delimiters to oldDelims
            end if
        end try
        
        -- Get dates
        set due_date_str to ""
        set activation_date_str to ""
        set creation_date_str to ""
        set modification_date_str to ""
        set completion_date_str to ""
        set cancellation_date_str to ""
        
        try
            set dd to due date of theProject
            if dd is not missing value then set due_date_str to dd as string
        end try
        
        try
            set ad to activation date of theProject
            if ad is not missing value then set activation_date_str to ad as string
        end try
        
        try
            set cd to creation date of theProject
            if cd is not missing value then set creation_date_str to cd as string
        end try
        
        try
            set md to modification date of theProject
            if md is not missing value then set modification_date_str to md as string
        end try
        
        try
            set cpd to completion date of theProject
            if cpd is not missing value then set completion_date_str to cpd as string
        end try
        
        try
            set cnd to cancellation date of theProject
            if cnd is not missing value then set cancellation_date_str to cnd as string
        end try
        
        -- Get contact
        set contact_str to ""
        try
            set c to contact of theProject
            if c is not missing value then set contact_str to c as string
        end try
        
        -- Escape quotes in fields
        set project_id to my replaceText(project_id, "\"", "\"\"")
        set project_name to my replaceText(project_name, "\"", "\"\"")
        set area_id_str to my replaceText(area_id_str, "\"", "\"\"")
        set area_name_str to my replaceText(area_name_str, "\"", "\"\"")
        set project_notes to my replaceText(project_notes, "\"", "\"\"")
        set tag_names_str to my replaceText(tag_names_str, "\"", "\"\"")
        set contact_str to my replaceText(contact_str, "\"", "\"\"")
        
        -- Build CSV output
        set headerLine to "\"id\",\"name\",\"status\",\"area_id\",\"area_name\",\"notes\",\"tag_names\",\"due_date\",\"activation_date\",\"creation_date\",\"modification_date\",\"completion_date\",\"cancellation_date\",\"contact\""
        set csvLine to "\"" & project_id & "\",\"" & project_name & "\",\"" & project_status & "\",\"" & area_id_str & "\",\"" & area_name_str & "\",\"" & project_notes & "\",\"" & tag_names_str & "\",\"" & due_date_str & "\",\"" & activation_date_str & "\",\"" & creation_date_str & "\",\"" & modification_date_str & "\",\"" & completion_date_str & "\",\"" & cancellation_date_str & "\",\"" & contact_str & "\""

        -- Get to-dos for this project
        set todosHeaderLine to "\"id\",\"name\",\"status\",\"notes\",\"tag_names\",\"due_date\",\"creation_date\",\"modification_date\",\"completion_date\""
        set todosOutput to todosHeaderLine & linefeed
        
        set todosList to to dos of theProject
        repeat with theTodo in todosList
            set todo_id to id of theTodo
            set todo_name to name of theTodo
            set todo_status to (status of theTodo) as string
            
            -- Get notes
            set todo_notes to ""
            try
                set todo_notes to notes of theTodo as string
            end try
            
            -- Get tag names
            set todo_tag_names_str to ""
            try
                set todo_tag_list to tag names of theTodo
                if (count of todo_tag_list) > 0 then
                    set oldDelims to AppleScript's text item delimiters
                    set AppleScript's text item delimiters to "; "
                    set todo_tag_names_str to todo_tag_list as string
                    set AppleScript's text item delimiters to oldDelims
                end if
            end try
            
            -- Get dates
            set todo_due_date_str to ""
            set todo_creation_date_str to ""
            set todo_modification_date_str to ""
            set todo_completion_date_str to ""
            
            try
                set dd to due date of theTodo
                if dd is not missing value then set todo_due_date_str to dd as string
            end try
            
            try
                set cd to creation date of theTodo
                if cd is not missing value then set todo_creation_date_str to cd as string
            end try
            
            try
                set md to modification date of theTodo
                if md is not missing value then set todo_modification_date_str to md as string
            end try
            
            try
                set cpd to completion date of theTodo
                if cpd is not missing value then set todo_completion_date_str to cpd as string
            end try
            
            -- Escape quotes
            set todo_id to my replaceText(todo_id, "\"", "\"\"")
            set todo_name to my replaceText(todo_name, "\"", "\"\"")
            set todo_notes to my replaceText(todo_notes, "\"", "\"\"")
            set todo_tag_names_str to my replaceText(todo_tag_names_str, "\"", "\"\"")
            
            -- Build CSV line
            set todoCsvLine to "\"" & todo_id & "\",\"" & todo_name & "\",\"" & todo_status & "\",\"" & todo_notes & "\",\"" & todo_tag_names_str & "\",\"" & todo_due_date_str & "\",\"" & todo_creation_date_str & "\",\"" & todo_modification_date_str & "\",\"" & todo_completion_date_str & "\""
            set todosOutput to todosOutput & todoCsvLine & linefeed
        end repeat
        
        -- Output project info
        return headerLine & linefeed & csvLine & linefeed & linefeed & todosOutput
    end tell
end run
EOF
